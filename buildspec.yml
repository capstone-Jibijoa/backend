version: 0.2

# ðŸ’¡ ìˆ˜ì •: variables ì„¹ì…˜ì„ ì œê±°í•©ë‹ˆë‹¤. ë³€ìˆ˜ëŠ” commands ì„¹ì…˜ ì•ˆì—ì„œ export í•©ë‹ˆë‹¤.
# variables: (ì‚­ì œ)

phases:
  pre_build:
    commands:
      # 1. í™˜ê²½ ë³€ìˆ˜ ì •ì˜ ë° export (commands ì„¹ì…˜ ì•ˆì—ì„œ ì •ì˜)
      - export ECR_REPO_NAME="jibijoa-backend"
      - export AWS_ACCOUNT_ID="121568407787"
      - export AWS_REGION="ap-southeast-2"
      - export ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}"
      
      - echo "Resolving commit hash..."
      # 2. COMMIT_HASH ì¶”ì¶œ
      - export COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - echo "COMMIT_HASH: $COMMIT_HASH"
      
      # 3. ECR ë¡œê·¸ì¸
      - echo "Logging in to Amazon ECR..."
      - aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_URI}

  build:
    commands:
      - echo "Building Docker image..."
      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - docker build -t ${ECR_URI}:${COMMIT_HASH} .

  post_build:
    commands:
      # 5. ECR í‘¸ì‹œ
      - echo "Pushing image to ECR..."
      - docker push ${ECR_URI}:${COMMIT_HASH}

      # 6. ECS ë°°í¬ ì •ì˜ íŒŒì¼ ìƒì„±
      - echo "Creating imagedefinitions.json..."
      - printf '[{"name":"fastapi-backend","imageUri":"%s"}]' "${ECR_URI}:${COMMIT_HASH}" > imagedefinitions.json
      - cat imagedefinitions.json

artifacts:
  files:
    - imagedefinitions.json